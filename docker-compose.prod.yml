services:
  postgres:
    image: postgres:16-alpine
    container_name: image-mgmt-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5430:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./storage/images:/storage/images
      - ./storage/thumbnails:/storage/thumbnails
      - ./database/init:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - im-network

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: image-mgmt-api
    environment:
      # Database Configuration
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/postgres

      # Server Configuration
      API_PORT: 3000
      NODE_ENV: production
      HOST: 0.0.0.0

      # File Storage
      STORAGE_PATH: ./storage
      IMAGES_PATH: ./storage/images
      THUMBNAIL_PATH: ./storage/thumbnails
      MAX_FILE_SIZE: 52428800

      # Image Processing
      THUMBNAIL_WIDTH: 300
      THUMBNAIL_HEIGHT: 300
      THUMBNAIL_QUALITY: 70
      SUPPORTED_FORMATS: jpg,jpeg,png,tif,tiff

      # Security
      ALLOWED_FILE_TYPES: jpg,jpeg,png,tif,tiff
      MAX_UPLOAD_FILES: 50
      CORS_ORIGIN: "*"

      # Logging
      LOG_LEVEL: info
    ports:
      - "3000:3000"
    volumes:
      - ./storage/images:/app/storage/images
      - ./storage/thumbnails:/app/storage/thumbnails
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - im-network

networks:
  im-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
